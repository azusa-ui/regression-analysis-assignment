---
title: "Group 1 : Multivariable Linear Regression Analysis"
author:
  - "AHMAD ZULFAHMI BIN SHA'ARI (23202546)"
  - "MOHD FAIZ BIN MOHD GHAZALI (23202458)"
  - "MUHAMAD SYAFIQ BIN ZAINUL ABIDIN (23202675)"
  - "ZAINAL BIN ZULKIFLI  (23203043)"
date: today
format: 
  html:
    theme: cosmo
    toc: true
    toc-location: left
    toc-depth: 3
    number-sections: true
    embed-resources: true
    code-fold: true
    code-tools: true
    smooth-scroll: true
    df-print: kable
    tbl-cap-location: top
    fig-cap-location: bottom
execute:
  warning: false
  message: false
  echo: true
---

# **Part A: Introduction and data generation**

In public health epidemiology, understanding how modifiable lifestyle factors interact with Quality of Life (QoL) is essential for designing targeted interventions. The objective of this analysis is to evaluate the independent and interactive effects of physical activity, obesity status, and years of working on Quality of Life (QoL) among working adults, with particular emphasis on determining whether obesity modifies the relationship between physical activity and QoL.

Specifically, the analysis aims to quantify the extent to which physical activity improves QoL, assess the baseline and cumulative negative impact of obesity and longer working duration, and examine whether the beneficial effect of physical activity is attenuated among obese individuals, thereby providing evidence to inform targeted, integrated public health and occupational health interventions.

The R syntax for datasets were generated using Generative AI (ChatGPT 5.2) to emulate realistic epidemiological structures, including:

-   Generate synthetic qol dataset (n=200)

-   QoL: 0-100

-   Years of Working: 0-40

-   Physical Activity Score : 0-10

-   Obesity factor (2 levels)

-   Interaction: PhysActivity \* Obesity

-   Plausible effect sizes

-   Interaction between physical activity and obesity

-   Deliberately inserted influential observations for diagnostic demonstration

The dataset then was saved in csv file format. Details of the data generation summary and files related to analysis are available at <https://github.com/azusa-ui/regression-analysis-assignment.git>

```{r}
# ============================================================
# Generate synthetic qol dataset (n=200)
# - qol: 0-100
# - YearsWorking: 0-40
# - PhysActivity: 0-10
# - Obesity factor (2 levels)
# - Interaction: PhysActivity * Obesity
# - Random influential observations
# ============================================================

library(dplyr)
library(tibble)

set.seed(999)
n <- 200

# -----------------------------
# Generate covariates
# -----------------------------
datar <- tibble(
  years_working = runif(n, 0, 40),
  phys_activity = runif(n, 0, 10),
  obesity = sample(c("obese", "not obese"), n, replace = TRUE, prob = c(0.35, 0.65))
) %>%
  mutate(obese_bin = if_else(obesity == "obese", 1, 0))

# -----------------------------
# Outcome with interaction
# -----------------------------
coefs <- list(beta0 = 75, beta_yr = -0.4, beta_pa = 3.0, beta_ob = -15, beta_int = -3)
sigma <- 6

datar <- datar %>%
  mutate(qol = coefs$beta0 +
           coefs$beta_yr * years_working +
           coefs$beta_pa * phys_activity +
           coefs$beta_ob * obese_bin +
           coefs$beta_int * phys_activity * obese_bin +
           rnorm(n, 0, sigma)) %>%
  mutate(qol = pmin(pmax(qol, 0), 100)) %>%
  dplyr::select(qol, years_working, phys_activity, obesity)

# -----------------------------
# Inject influential observations
# -----------------------------
infl_idx <- sample(1:n, 6)

datar <- datar %>%
  mutate(
    qol = replace(qol, infl_idx, c(95, 15, 90, 10, 5, 98)),
    years_working = replace(years_working, infl_idx, c(40, 0, 39.5, 38.8, 1.0, 0.5)),
    phys_activity = replace(phys_activity, infl_idx, c(0, 10, 9.8, 0.2, 9.9, 0.1)),
    obesity = replace(obesity, infl_idx, c("obese", "not obese", "obese", "not obese", "obese", "not obese"))
  )

# -----------------------------
# Shuffle rows
# -----------------------------
datar <- datar %>% slice_sample(prop = 1)

# -----------------------------
# Save dataset
# -----------------------------

#write.csv(datar, "data_lm.csv", row.names = FALSE)

```

## Glimpse the generated dataset

```{r}
library(dplyr)
library(readr)

data <- read_csv("data_lm.csv")

# Round all numeric columns to integers
data <- data %>%
  mutate(across(where(is.numeric), ~ round(.x, 0)))

glimpse(data)

```

## Setting up the Environment

### Load Required Libraries

```{r}
# Data Manipulation
library(tidyverse)    
library(dplyr)
library(modelr)

# Data Summarization & Tables
library(summarytools)
library(gt)
library(gtsummary)
library(knitr)
library(DT)

# Statistical Modeling & Diagnostics
library(broom)
library(broom.helpers)
library(performance)
library(car)
library(lmtest)
library(interactions)

# Visualization
library(ggplot2)
library(GGally)
library(corrplot)
library(ggeffects)
library(patchwork)

```

### Transform data

```{r}
# Change obesity to factors and set reference level
data <- data %>% 
    mutate(obesity = factor(obesity,levels = c("not obese", "obese")))

library(labelled)
var_label(data$years_working) <- "Years of Working"
var_label(data$phys_activity) <- "Physical Activity Score"
var_label(data$obesity) <- "Obesity Status"
var_label(data$qol) <- "Quality of Life"

glimpse(data)
```

# **Part B: Exploratory Data Analysis**

## Summary Statistics

```{r}
print(dfSummary(data,  
                style        = "multiline",  
                varnumbers   = FALSE,
                valid.col    = FALSE
                ),
      method = "render")
```

**Comment:** This dataset consists of 200 observations and four variables with no missing data or duplicates. The participants have an average of 19.8 years of work experience (ranging from 0 to 40) and report a mean Quality of Life score of 70.2 on a 100-point scale. Physical activity levels are moderate, averaging 4.8 on a 10-point scale, while the categorical data reveals that 63.5% of the group is classified as "not obese" and 36.5% as "obese."

## Visualizations

### Histograms

```{r}
#| fig-cap: "**Figure 1: Distribution of Continuous Variables**"

data |> 
  pivot_longer(c(qol, years_working, phys_activity)) |> 
  ggplot(aes(value)) +
  geom_histogram(bins = 10, fill = "skyblue", color = "black") +
  facet_wrap(~name, scales = "free") +
  theme_minimal() +
  labs(
    x = "Value",
    y = "Frequency"
  ) +
  theme(
    plot.caption = element_text(hjust = 0.0, face = "bold", size = 10) 
  )

```

**Interpretation:** The Figure 1 contains three histograms showing the frequency distributions of continuous variables. The phys_activity plot ranges from $0$ to $10$ with a peak around $4$-$5$. The QoL plot is left-skewed on a $0$-$100$ scale, peaking around $75$-$80$. The years_working plot shows a multimodal distribution spanning from $0$ to over $40$ years.

### Box Plots of Continuous Variables by Categorical Variables

```{r}
#| fig-cap: "**Figure 2: Box Plots of Continuous Variables by Obesity Status**"

data %>%
  pivot_longer(
    cols = where(is.numeric),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(obesity, value, fill = obesity)) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~ variable, scales = "free_y") +
  scale_fill_manual(values = c("not obese" = "#2E86AB", "obese" = "#F6C85F")) +  
  theme_minimal() +
  labs(
    x = "Obesity Status",
    y = "Value"
    ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.caption = element_text(hjust = 0.0, face = "bold", size = 10))
```

**Interpretation:** Figure 2 displays three sets of side-by-side box plots comparing continuous variables by Obesity Status ("not obese" in blue and "obese" in yellow). It highlights that the median quality of life is significantly higher for the "not obese" group compared to the "obese" group, while physical activity levels and years working have similar median values across both categories.

### Scatter plots between continuous variables

```{r}
#| fig-cap: "**Figure 3 :Scatter plots showing relationships between Quality of Life, Work Experience, and Physical Activity.**"

plot_scatter <- function(x, y, title, xlab, ylab, col) {
  ggplot(data, aes({{ x }}, {{ y }})) +
    geom_point(alpha = 0.6, color = col) +
    geom_smooth(method = "lm", se = TRUE,
                color = col, fill = scales::alpha(col, 0.2)) +
    theme_minimal() +
    labs(title = title, x = xlab, y = ylab) +
    theme(
      plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
      plot.margin = margin(10, 5, 10, 5)
    )
}

# 2. Assign plots to variables
p1 <- plot_scatter(years_working, qol,
                   "Quality of Life vs\nYears Working", 
                   "Years Working", "Quality of Life", "#A0522D")

p2 <- plot_scatter(phys_activity, qol,
                   "Quality of Life vs\nPhysical Activity", 
                   "Physical Activity", "Quality of Life", "#008080")

p3 <- plot_scatter(phys_activity, years_working,
                   "Years Working vs\nPhysical Activity", 
                   "Physical Activity", "Years Working", "#800080")

# 3. Combine using patchwork layout for better spacing
(p1 | p2 | p3) + 
  plot_layout(ncol = 3) & 
  theme(plot.title = element_text(size = 9)) 

```

**Interpretation:** Figure 3 consists of three scatter plots with overlaid linear regression lines and shaded confidence intervals. It visualizes the relationships between Quality of Life vs. Years Working (slight negative slope), Quality of Life vs. Physical Activity (slight positive slope), and Years Working vs. Physical Activity (slight negative slope).

### Bar plots for categorical variables

```{r}
#| fig-cap: "**Figure 4 :Distribution of Obesity Status.**"

ggplot(data, aes(x = obesity, fill = obesity)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Obesity Status",
       y = "Count") +
  scale_fill_brewer(palette = "Set1")
```

**Interpretation:** Figure 4 shows a simple bar chart comparing the counts of individuals by obesity status. The red bar indicates that there are $127$ "not obese" individuals, while the blue bar shows approximately $73$ "obese" individuals in the dataset.

### Correlation matrices for continuous variables

```{r}
#| fig-cap: "**Figure 5: Correlation Matrix of QoL, Years Working, and Physical Activity**"

# Select continuous variables
continuous_vars <- data %>%
  dplyr::select(qol, years_working, phys_activity)

# Compute correlation matrix
cor_matrix <- cor(continuous_vars, use = "complete.obs", method = "pearson")

# Plot correlation matrix
corrplot(
  cor_matrix,
  method = "color",
  type = "upper",
  tl.col = "black",
  tl.srt = 45,
  addCoef.col = "brown",
  number.cex = 0.8,
  mar = c(0, 0, 2, 0)
)
```

**Interpretation:** Figure 5 shows correlation matrices between the continuous variables. It reveals that QoL has a weak positive relationship with physical activity ($r$ = 0.23) and a weak negative relationship with years working ($r$ = -0.21), while years working and physical activity share a negligible negative correlation of -0.16.

# **Part C: Regression Analysis**

## **Univariable linear regression models**

### Years working

```{r}
yw <- lm(qol ~ years_working, data = data)
yw_result <-tidy(yw, conf.int = TRUE) |>
  mutate(p.value = format.pval(p.value, digits = 2, eps = 0.001))

kable(yw_result, digits = 3)
glance(yw)
```

**Interpretation:** The resulting model reveals that years working is a statistically significant, albeit weak, predictor of QoL ($p = 0.0027$). With an intercept of $76.68$, the model suggests a baseline QoL for those entering the workforce, while the slope coefficient of $-0.326$ indicates a marginal decline in wellbeing for every additional year of employment. However, the coefficient of determination ($R^2 = 0.044$) demonstrates that work duration accounts for only $4.4\%$ of the total variance in QoL scores, confirming the low-magnitude negative correlation ($r = -0.21$) previously observed in the descriptive analysis.

### Physical Activity

```{r}
pa <- lm(qol ~ phys_activity, data = data)
pa_result <- tidy(pa, conf.int = TRUE) |>
  mutate(p.value = format.pval(p.value, digits = 2, eps = 0.001))

kable(pa_result, digits = 3)

glance(pa) 
```

**Interpretation:** The model reveals that physical activity is a statistically significant predictor of QoL ($p = 0.0011$). The regression intercept of $63.36$ represents the estimated qol score for individuals with a baseline physical activity level of zero. Furthermore, the positive slope coefficient of $1.44$ indicates that for every one-unit increase in the physical activity scale, the QoLscore is expected to rise by approximately $1.44$ units. Despite this significant association, the coefficient of determination ($R^2 = 0.0526$) suggests that physical activity accounts for only $5.26\%$ of the total variance in QoL, which aligns with the weak positive correlation ($r = 0.23$) identified in the initial correlation matrix.

### Obesity

```{r}
ob <- lm(qol ~ obesity, data = data)
ob_result <-tidy(ob, conf.int = TRUE) |>
  mutate(p.value = format.pval(p.value, digits = 2, eps = 0.001))

kable(ob_result, digits = 3)

glance(ob)
```

**Interpretation:** The model identifies obesity as a highly significant and substantial predictor of QoL ($p < 0.001$), accounting for $50.38\%$ of the total variance in scores ($R^2 = 0.504$). The intercept of $80.10$ represents the estimated mean QoLfor the "not obese" reference group, a finding that aligns with the higher median values observed in the initial descriptive box plots. In contrast, the coefficient for the "obese" category indicates a statistically significant decrease of $27.06$ units in the qol score compared to the non-obese cohort.

### Summary of univariable analysis

```{r}

#| tbl-cap: "**Table 1: Summary of Univariable Regression Models**"

# Variable labels
var_labels <- list(
  qol = "Quality of Life",
  years_working = "Years Working",
  phys_activity = "Physical Activity Score",
  obesity = "Obesity Status"
)

# Extract R-squared
r2_table <- tibble(
  variable = c("years_working", "phys_activity", "obesity"),
  r.squared = c(
    glance(yw)$r.squared,
    glance(pa)$r.squared,
    glance(ob)$r.squared
  )
)

# Create table
data |>
  dplyr::select(qol, years_working, phys_activity, obesity) |>
  tbl_uvregression(
    method = lm,
    y = qol,
    exponentiate = FALSE,
    conf.level = 0.95,
    label = var_labels,
    pvalue_fun = ~style_pvalue(.x, digits = 3, eps = 0.001),
    estimate_fun = ~style_number(.x, digits = 2)
  ) |>
  modify_caption("**Table 1: Summary of Univariable Regression Models**") |>
  bold_p() %>% 
  bold_labels() %>% 
  modify_table_body(
    ~ .x |>
      left_join(r2_table, by = "variable") |>
      relocate(r.squared, .after = p.value) |>
      mutate(r.squared = style_number(r.squared, digits = 3))
  ) |>
  modify_header(
    label = "**Variables**",
    r.squared = "**R²**"
  )


```

**Summary:** The univariable regression models summarized in Table 1 indicate that all three independent variables are statistically significant predictors of QoL. Obesity status emerged as the most substantial predictor, accounting for 50.4% of the variance in QoL ($R^2 = 0.504$), with obese individuals scoring 27.06 units lower than the "not obese" reference group ($p < 0.001$). Physical activity and years working, while significant, demonstrated much weaker associations, explaining only 5.3% and 4.4% of the variance respectively. Specifically, each one-unit increase in physical activity is associated with a 1.44-unit rise in qol ($p = 0.001$), whereas each additional year of work experience correlates with a 0.33-unit decline ($p = 0.003$).

## **Multivariable linear regression models**

### Model 1: Main effects only

```{r}
#| tbl-cap: "**Table 2: Multivariable Regression Model 1: Main Effects Only**"

m1 <- lm(qol ~ years_working + phys_activity + obesity, data = data)
tblm1 <-tidy(m1, conf.int = TRUE) |>
  mutate(p.value = format.pval(p.value, digits = 2, eps = 0.001))

kable(tblm1, digits = 3)

```

**Interpretation :** Model 1 shows good overall fit, with all predictors demonstrating strong and independent associations with quality of life (p \< 0.001) and precise estimates, indicating stable model performance. Increasing years of working is associated with a modest but significant decline in QoL (β = −0.31), while higher physical activity is linked to improved QoL (β = 1.24), highlighting its protective role. Obesity emerges as the strongest determinant, with obese individuals experiencing markedly lower QoL scores (β = −27.29) compared with non-obese individuals.

### Model 2: Interaction between years physical activity and obesity

```{r}
#| tbl-cap: "**Table 3: Multivariable Regression Model 2: With Interaction Term**"

m2 <- lm(qol ~ years_working + phys_activity * obesity, data = data)
tblm2 <- tidy(m2, conf.int = TRUE) |>    
  mutate(p.value = format.pval(p.value, digits = 2, eps = 0.001))

kable(tblm2, digits = 3)

```

**Interpretation :** Model 2 demonstrates good overall fit with all main effects and the interaction term being highly significant (p \< 0.001), indicating meaningful effect modification. Years working remains negatively associated with QoL (β = −0.30), showing a stable effect across models. Physical activity has a stronger positive association with QoL among non-obese individuals (β = 2.29); however, the significant negative interaction term (β = −2.79) indicates that this beneficial effect is substantially attenuated among obese individuals. Although obesity independently remains associated with lower QoL (β = −14.03), its magnitude is reduced compared with the main-effects model, suggesting that part of the obesity effect operates through differential response to physical activity.

### Compare Model 1 and Model 2

#### Partial F-test

```{r}
#| tbl-cap: "**Table 4: Comparison of Models Using Partial F-Test**"

anova_tbl <- anova(m1, m2, test = "F")
kable(anova_tbl, digits = 3)

```

**Interpretation :** Comparison of the models shows that Model 2 provides a significantly better fit than Model 1. The inclusion of the physical activity × obesity interaction reduces the residual sum of squares from 27,276.51 to 24,170.14, with a substantial explained sum of squares (ΔSS = 3,106.37). The partial F-test confirms that this improvement is statistically significant (F = 25.06, p \< 0.001), indicating that the interaction term adds meaningful explanatory value beyond the main effects alone. Therefore, Model 2 is statistically superior and better captures the differential effect of physical activity on QoL by obesity status.

#### Using performance package

```{r}
#| tbl-cap: "**Table 5: Model Comparison of m1 and m2 Using Performance Metrics**"


library(performance)
compare_performance(m1, m2, rank = TRUE)
```

**Interpretation :** Model 2 clearly outperforms m1 across all evaluation criteria; it explains more variance (higher R² and adjusted R²), has lower prediction error (lower RMSE and sigma), and is overwhelmingly preferred by information criteria (AIC, AICc, and BIC).

### Preliminary final model

```{r}
#| tbl-cap: "**Table 6: Preliminary Final Model Regression Table**"

prelim_tbl <- tbl_regression(
  m2,
  intercept = TRUE,
  conf.level = 0.95,
  label = var_labels,
  pvalue_fun = ~style_pvalue(.x, digits = 3, eps = 0.001),
  estimate_fun = ~style_number(.x, digits = 2)
) |>
  add_glance_table(
    include = c(r.squared, adj.r.squared, AIC)
  ) |>
  modify_caption("**Table 6: Preliminary Final Model Regression Table**") |>
  bold_p() %>% 
  bold_labels()
    
    
prelim_tbl
```

# **Part D: Model Checking**

## Check assumptions

### Generate predicted values and residuals

```{r}
data.fitted <- augment(m2)
```

### Assumption 1: Linearity

#### Overall linearity

```{r}
#| fig-cap: "**Figure 6: Residual VS Fitted Plot**"

# Residuals vs Fitted plot
plot(m2, which = 1)
```

**Interpretation :** The Residuals vs Fitted plot suggests that the linearity assumption is generally satisfied, as the red smoother line remains relatively horizontal and centered near zero across the range of fitted values. The spread of residuals appears consistent for the majority of the data, indicating homoscedasticity; however, there are several prominent outliers (specifically observations 65, 178, and 104) that deviate significantly from the model's predictions.

#### Linearity for each numerical predictor

```{r}
#| fig-cap: "**Figure 7: Residual VS Predictor Plot**"

y.resid <- ggplot(data.fitted, aes(x = years_working, y = .resid)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Years Working",
       x = "Years Working",
       y = "Residuals")
p.resid <- ggplot(data.fitted, aes(x = phys_activity, y = .resid)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Physical Activity",
       x = "Physical Activity",
       y = "Residuals")

y.resid + p.resid
```

**Interpretation :** Figure 7 confirm that the linearity assumption is met for both "Years Working" and "Physical Activity," as the red smoother lines are nearly horizontal and centered at zero. The consistent vertical spread of points across the x-axes supports homoscedasticity, although extreme values on both predictor scales exhibit significant outliers that mirror the findings from the global diagnostic plot. Since no distinct curved patterns are visible, these results suggest that the current linear specification for these individual predictors is appropriate and does not require non-linear transformations.

### Assumption 2: Normality of Residuals

```{r}
#| fig-cap: "**Figure 8: Q-Q Residuals and Histogram of Residuals**"

par(mfrow = c(1, 2))
plot(m2, which = 2)
hist.resid <- hist(data.fitted$.resid, breaks = 30,
                   main = "Histogram of Residuals",
                   xlab = "Residuals",
                   col = "steelblue",
                   border = "black")               
```

**Interpretation :** The Q-Q Residuals and Histogram of Residuals plots evaluate the normality assumption of the model's error terms. While the central portion of the histogram shows a strong, bell-shaped peak around zero and the majority of points in the Q-Q plot follow the dashed reference line, both visualizations reveal heavy tails and significant outliers. Specifically, observations 65, 178, and 104 appear as extreme negative values, causing the Q-Q plot to deviate sharply from the line at the lower end.

### Assumption 3: Homoscedasticity

#### Visual diagnostics

```{r}
#| fig-cap: "**Figure 9: Scale-Location and Residuals vs Fitted plots**"

par(mfrow = c(1, 2))
plot(m2, which = c(1,3))
```

**Interpretation :** The Scale-Location and Residuals vs Fitted plots showing a relatively horizontal red smoother line that suggests the homoscedasticity and linearity assumptions are largely held. The points in the Scale-Location plot are spread randomly without a clear funnel shape, indicating that the variance of the residuals remains consistent across the range of fitted values. However, the consistent appearance of extreme outliers (observations 65, 178, and 104) across all diagnostic views confirms that while the general trend is well-captured, specific data points deviate significantly and may require individual inspection to ensure they do not bias the overall regression results.

#### Breusch-Pagan Test

```{r}
bptest(m2)
```

**Interpretation :** The Breusch-Pagan test results indicate that the homoscedasticity assumption is satisfied as the p-value of 0.6958 means it fail to reject the null hypothesis, which states that the variance of the error terms is constant across all levels of the independent variables.

### Assumption 4: Independence of Residuals

We assess the independence of residuals using visual diagnostics, autocorrelation function (ACF) plots, and the Durbin-Watson test (1)(3).

#### Visual diagnostics

```{r}
#| fig-cap: "**Figure 10: Residuals vs Index**"

plot(residuals(m2), type = "o")
abline(h = 0, col = "blue", lty = 2)
```

**Interpretation :** Figure 10 shows the independence assumption by displaying the residuals in the order they were collected. The points appear to be randomly scattered around the horizontal zero line without any discernible patterns, such as runs or cycles, suggesting that there is no significant autocorrelation or time-dependent bias in the data. However, consistent with previous diagnostics, the plot clearly highlights extreme outliers (specifically around indices 65, 104, and 178) that deviate sharply from the main cluster of observations.

#### Autocorrelation Function (ACF) plot

```{r}
#| fig-cap: "**Figure 11: Autocorrelation Function (ACF) of Model Residuals**"

acf(data.fitted$.resid, main = "ACF of Residuals")
```

**Interpretation :** Figure 11 confirms that the independence assumption is satisfied, as there is no evidence of systematic autocorrelation in the model’s errors. In the ACF plot, all spikes after lag 0 fall within the blue dashed significance boundaries (except for a minor, negligible dip at lag 4), indicating that the residuals are stochastically independent and not correlated with their own past values.

#### Durbin-Watson Test

```{r}
dwtest(m2)
```

**Interpretation :** The Durbin-Watson test results provide strong statistical evidence that the independence of errors assumption is satisfied for the Model 2. With a DW statistic of 2.0749, there is no indication of significant autocorrelation in the residuals. Furthermore, the p-value \>0.05 , meaning the Model 2 fail to reject the null hypothesis of no autocorrelation.

## Checking influentials

### Cook’s distance

Cook’s distance is used to detect influential observations that could disproportionately impact the model’s estimates. A commonly used threshold for identifying such points is 4 divided by the total number of observations (4/n).

```{r}
infl <- influence.measures(m2)
infl.val <- data.frame(infl$infmat)

cutoff.cook.d <- 4 / nrow(data)

influential.obs <- infl.val |> 
  mutate(obs_id = row_number()) |> 
  filter(cook.d > cutoff.cook.d)

cat("Number of influential observations:", nrow(influential.obs), "\n")
cat("Cut-off value for Cook's Distance:", cutoff.cook.d, "\n")


if(nrow(influential.obs) > 0) {
  influential.obs |> 
    dplyr::select(obs_id, cook.d, hat) |> 
    arrange(desc(cook.d)) |> 
    head(10)
}

```

```{r}
#| fig-cap: "**Figure 12: Cook's Distance Plot for Identifying Influential Observations**"

plot(m2, which = 4, id.n = 5)
abline(h = cutoff.cook.d, col = "red", lty = 2)
```

**Interpretation**: The Cook's Distance plot identifies several influential observations that exceed the calculated cut-off value of 0.02, indicating that these specific data points disproportionately affect the model's estimated coefficients. Specifically, observations 104, 65, 200, 108, 178 and 17 are flagged, with observation 104 exerting the greatest influence.

```{r}
# Top 5 most influentials obs
data[c(104, 65, 200, 108, 178 ), ] 
```

These points should be reviewed for potential data entry errors or anomalies. If no issues are identified, it is advisable to refit the model excluding these observations to evaluate how much they affect the regression results.

#### Residuals vs Leverage plot

```{r}
#| fig-cap: "**Figure 13: Residuals vs Leverage Plot**"

plot(m2, which = 5)
```

**Interpretation**: Figure 13 confirms that while most observations have low influence, specific data points are significantly biasing the model. Observations 104, 65, and 200 are positioned near or beyond the dashed Cook's distance contour lines, indicating they possess both high leverage (unusual predictor values) and high residuals (poor fit).

### Using DFBETAS

We use threshold of 2/sqrt(n) to identify influential observations for each predictor.

```{r}
# Compute DFBETAS and display as a datatable
dfb <- dfbetas(m2)
dfb_long <- dfb |> 
  as.data.frame() |> 
  mutate(id = row_number()) |> 
  pivot_longer(
    cols = -id,
    names_to = "term",
    values_to = "dfbeta"
  )

# Cutoff
dfb_threshold <- 2 / sqrt(nrow(data))

# Identify influential observations
influential_dfb <- dfb_long |> 
  filter(abs(dfbeta) > dfb_threshold) |>
  arrange(desc(abs(dfbeta)))
influential_dfb %>%
  datatable()

```

```{r}
#| fig-cap: "**Figure 14: DFBETAS for Each Observation**"

# Plot DFBETAS with colorblind-friendly palette

ggplot(dfb_long, aes(x = id, y = dfbeta, color = term)) +
  geom_point(alpha = 0.7, size = 2.5) +
  geom_hline(yintercept = c(dfb_threshold, -dfb_threshold), linetype = "dashed", color = "red") +
  labs(
    title = "DFBETAS for Each Observation",
    x = "Observation ID",
    y = "DFBETA",
    color = "Predictor Variable"
  ) +
  scale_color_viridis_d(option = "D") +  
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 12),
    plot.title = element_text(face = "bold", hjust = 0.5))
```

**Interpretation**: Figure 14 demonstrates that the model is stable, as the vast majority of observations do not exert disproportionate influence on the estimated coefficients. While a few data points exceed the standard threshold (indicated by the dashed red lines), they remain well below the critical value of $|1.0|$. This indicates that no single participant's data is fundamentally altering the results for predictors like obesity, physical activity, or their interaction.

### Using Leverage Values and Standardized Residuals Cutoff

We will flag observations with standardized residuals above 2 or below -2, and those with leverage values exceeding the calculated threshold. The leverage cutoff is computed as 2 × (p + 2) / n, where p is the number of predictors and n is the total number of observations.

```{r}

# Compute leverage cutoff
leverage_cutoff <- 2 * (length(coef(m2)) + 2) / nrow(data)

# Add row ID
data.fitted <- data.fitted %>%
  mutate(id = row_number())

# Identify influential points
influential <- data.fitted %>%
  filter(abs(.std.resid) > 2 | .hat > leverage_cutoff) %>%
  mutate(status = "Influential")

# Non-influential points
non_influential <- data.fitted %>%
  filter(!(abs(.std.resid) > 2 | .hat > leverage_cutoff)) %>%
  mutate(status = "Normal")

# Combine
plot_data <- bind_rows(influential, non_influential)

# Display influential points in a datatable
influential %>% datatable()

```

```{r}
#| fig-cap: "**Figure 15: Standardized Residuals vs Leverage Plot**"

# Plot standardized residuals vs leverage
ggplot(plot_data, aes(x = .hat, y = .std.resid, color = status)) +
  geom_point(alpha = 0.8, size = 2.5) +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "red") +
  geom_vline(xintercept = leverage_cutoff, linetype = "dashed", color = "red") +
  labs(
    title = "Standardized Residuals vs Leverage",
    x = "Leverage (.hat)",
    y = "Standardized Residuals (.std.resid)",
    color = "Observation Status"
  ) +
  scale_color_viridis_d(option = "D", end = 0.8) +  
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

**Interpretation**: Figure 15 shows that while a few observations are flagged as "Influential" due to high residuals or leverage, the vast majority remain within normal bounds, indicating the model is generally robust and not unduly driven by outliers.

## Model Refinement

We will conduct a sensitivity analysis by removing six influential observations consistently identified across Cook’s distance, supported by the leverage values, standardized residuals, and DFBETAs diagnostics. These points exerted disproportionate influence on regression estimates. Their exclusion aimed to improve model performance, stability, and interpretability of the linear regression results.

### Refitted Model Following Cook’s Distance Outlier Removal

```{r}
#| tbl-cap: "**Table 7 : Multivariable Regression Model 3: Refitted Model**"


n <- nrow(data.fitted)

# Threshold for Cook's distance
cooks_thresh <- 4 / n

# Filter out influential points based on Cook's distance
data.cleaned <- data.fitted %>%
  mutate(.cooksd = cooks.distance(lm(qol ~ years_working + phys_activity * obesity,
                                      data = data.fitted))) %>%
  filter(.cooksd < cooks_thresh)

# Refit linear regression on cleaned data
m3 <- lm(qol ~ years_working + phys_activity * obesity,
                 data = data.cleaned)

# Output tidy coefficients 
tblm3 <-tidy(m3, conf.int = TRUE) |> mutate(p.value = format.pval(p.value, digits = 3, eps = 0.001))

kable(tblm3, digits = 3)


```

### Compare model fitness between preliminary final model with model after removing outliers

```{r}
#| tbl-cap: "**Table 8 : Model Comparison of Model 2 & 3 Using Performance Metrics**"
#| 
compare_performance(m2, m3, rank = TRUE)
```

**Interpretation**: Model 3 demonstrates markedly superior performance compared with Model 2, explaining a substantially greater proportion of variance in the outcome (R² = 0.882 vs 0.641; adjusted R² = 0.879 vs 0.634) and exhibiting much lower prediction error (RMSE = 5.764 vs 10.993; σ = 5.840 vs 11.133). Information‐theoretic criteria strongly favour Model 3, with AIC, AICc, and BIC weights of 1.00 and a performance score of 100%, indicating overwhelming support for this model as the best representation of the data, whereas Model 2 receives essentially no empirical support. This suggests that the additional predictors and interaction structure in Model 3 substantially improve model fit, precision, and explanatory power.

### Compare coefficient changes after removing outliers

```{r}
#| tbl-cap: "**Table 9 : Comparison of Coefficient Estimates With and Without Outliers**"

coef_comparison <- tidy(m2) %>%
  dplyr::select(term, estimate) %>%
  rename(estimate_prelim = estimate) %>%
  left_join(
    tidy(m3) %>%
      dplyr::select(term, estimate) %>%
      rename(estimate_refit = estimate),
    by = "term"
  ) %>%
  mutate(
    change_in_estimate = estimate_refit - estimate_prelim,
    percent_change = (change_in_estimate / estimate_prelim) * 100
  )
coef_comparison
```

**Interpretation**: After refitting the model, most coefficients changed modestly, indicating improved stability after removal of influential observations. The negative effect of years working and obesity became stronger, while the positive effect of physical activity increased slightly. The interaction term changed minimally, confirming that the key finding that obesity attenuates the beneficial effect of physical activity on QoL remains robust.

### Compare model diagnostics after removing outliers

```{r}
par(mfrow = c(1,2), mar = c(5,4,4,2))  # bottom, left, top, right

# Residuals vs Fitted
plot(m2, which = 1, main = "Preliminary Model")
plot(m3, which = 1, main = "Post-Cook's Model")

# Q-Q Plot
plot(m2, which = 2, main = "Preliminary Model")
plot(m3, which = 2, main = "Post-Cook's Model")

# Scale-Location
plot(m2, which = 3, main = "Preliminary Model")
plot(m3, which = 3, main = "Post-Cook's Model")

# Cook's Distance
plot(m2, which = 4, main = "Preliminary Model")
plot(m3, which = 4, main = "Post-Cook's Model")
```

**Interpretation**:

-   **Residuals vs Fitted :** The Initial Model shows a clear violation of linearity caused primarily by observation 104, which exerts enough leverage to pull the red trend line away from the zero baseline. In the Refined Model, after removing influential points, the scale of the residuals is reduced by more than half (from $\pm 50$ to $\pm 20$) and the trend line flattens significantly. This indicates that the refined version much more accurately represents the underlying linear relationship without being skewed by extreme individual data points.

-   **Q-Q Residuals :** In the Initial Model, the residuals exhibit "heavy tails" and significant departures from the diagonal line suggesting the normality assumption is violated. The Refined Model shows much better alignment with the theoretical quantiles, with the points following the dashed line closely throughout the range. This improvement validates that the errors in the refined model are approximately normally distributed, which is essential for making reliable statistical inferences.

-   **Scale-Location:** The Initial Model displays non-constant variance (heteroscedasticity), where the spread of residuals changes as the fitted values increase, largely driven by the extreme standardized residual of observation 104. In the Refined Model, the distribution of standardized residuals is more uniform and the red line remains relatively horizontal. This suggests that the refined model satisfies the homoscedasticity assumption, ensuring that the model’s prediction error is consistent across the entire range of values.

-   **Cook's Distance :** The Initial Model highlights that a few specific observations have a disproportionately high impact on the regression coefficients, with observation 104 far exceeding the common threshold of 0.5. The Refined Model drastically reduces the maximum influence, with all remaining values falling below 0.035. This result confirms that the refined model is significantly more robust, as its parameters are now representative of the general data trend rather than being dictated by a few influential outliers.

# **Part E: Results Presentation and Interpretation**

## Final Model

```{r}
library(gt)
library(gtsummary)

final_tbl <- tbl_regression(
  m3,
  intercept = TRUE,
  conf.level = 0.95,
  pvalue_fun = ~style_pvalue(.x, digits = 3, eps = 0.001),
  label = var_labels,
  estimate_fun = ~style_number(.x, digits = 2)
) |>
  add_glance_table(
    include = c(r.squared, adj.r.squared, AIC, statistic,nobs),
    label = list(statistic = "F-statistic")
  ) |>
  bold_p(t = 0.05) |>
  bold_labels() |>
  modify_header(
    label = "**Variables**",
    estimate = "**Adj. Beta**",
    std.error = "**SE**",
    statistic = "**t-stat**"
  ) |>
  modify_column_unhide(c(std.error, statistic)) |>
  modify_table_body(
    ~ .x |> dplyr::relocate(std.error, .after = estimate) |>
           dplyr::relocate(statistic, .before = p.value)
  ) |>
  modify_caption("**Table 10 : Final Multivariable Linear Regression Model for Quality of Life Score**") |> 
  as_gt() |>
  opt_align_table_header(align = "left") |>
  tab_options(
    table.border.top.style = "none",
    table.border.bottom.style = "none",
    heading.border.bottom.style = "solid",
    heading.border.bottom.color = "black",
    table_body.border.top.color = "black",
    table_body.border.bottom.style = "solid",
    table_body.border.bottom.color = "black",
    table_body.hlines.style = "none",
    column_labels.border.top.style = "solid",
    column_labels.border.top.width = px(2),
    column_labels.border.top.color = "black",
    column_labels.border.bottom.style = "solid",
    column_labels.border.bottom.width = px(2),
    column_labels.border.bottom.color = "black",
    data_row.padding = px(5)
  ) |>
  tab_style(
    style = cell_text(align = "right"),
    locations = cells_body(columns = -label)
  ) |>
  opt_align_table_header(align = "left")

final_tbl
```

## Final Model Equation

```{r}
coef_tbl <- tidy(m3)

beta0 <- round(coef_tbl$estimate[1],2)
beta1 <- round(coef_tbl$estimate[2],2)
beta2 <- round(coef_tbl$estimate[3],2)
beta3 <- round(coef_tbl$estimate[4],2)
beta4 <- round(coef_tbl$estimate[5],2)

cat(paste0("QoL = ", beta0, " + ", beta1, " * YearsWorking + ", 
           beta2, " * PhysActivity + ", beta3, " * Obesity + ", 
           beta4, " * (PhysActivity * Obesity) + ε"))

```

$$
\text{QoL} = 77.38 - 0.41 \times\text{Years Working} + 2.51 \times\text{Physical Activity} - 16.36 \times\text{Obesity} - 2.63 \times(\text{Physical Activity} \times \text{Obesity}) + \varepsilon
$$

## Interpretation

**1. Model Performance & Overall Fit**

-   The model explains a very large proportion of variability in QoL scores (R² = 0.882; adjusted R² = 0.879). The high F-statistic (353, p \< 0.001) indicates that the model provides a significantly better fit than a null model, while the relatively low AIC (1,242) supports strong model parsimony and goodness of fit. This indicates that approximately 88.2% of the variability in QoL scores is accounted for by years working, physical activity, obesity status, and their interactions.

**2. Interpretation of Coefficients (Main Effects & Interactions)**

-   The **intercept** represents the predicted QoL score for an individual who has worked 0 years, has a Physical Activity score of 0, and is not obese. Under these baseline conditions, the predicted QoL score is 77.38 (95% CI: 74.73, 80.04), providing a meaningful reference point against which all other effects in the model are interpreted.

-   **Years** **Working**: Holding physical activity and obesity status constant, each additional year of working is associated with a 0.41-point decrease in QoL score (95% CI: −0.49, −0.34; p \< 0.001). This indicates a steady cumulative decline in QoL across the working lifespan. Over a 40-year career, this would correspond to an approximate 16.4-point reduction in QoL, highlighting the potential long-term impact of occupational exposure, ageing, or work-related stressors on well-being.

-   **The Interaction Effect (Physical Activity × Obesity):** The interaction between physical activity and obesity status is statistically significant (β = −2.63, p \< 0.001), indicating that the effect of physical activity on QoL differs by obesity status. As a result, the main effects of physical activity and obesity cannot be interpreted in isolation; instead, they must be understood conditionally, depending on obesity status and activity level.

-   **Effect of Physical Activity (Stratified by Obesity Status):**

    -   **Non**-**obese** **individuals** **(reference group):** Physical activity has a strong positive association with QoL. For every 1-unit increase in physical activity score, QoL increases by 2.51 points (95% CI: 2.14, 2.88), indicating substantial gains in perceived well-being with higher activity levels.

    -   **Obese** **individuals**: The beneficial effect of physical activity is attenuated by the interaction term. The net effect is 2.51 - 2.63 = −0.12, suggesting that among obese individuals, increases in physical activity are associated with minimal to no improvement in QoL. This indicates that physical activity alone may be insufficient to generate meaningful QoL gains in this group without concurrent weight-related or metabolic improvements.

-   **Effect of Obesity (Conditional on Physical Activity):**

    -   The coefficient for obesity (−16.36) represents the difference in QoL between obese and non-obese individuals when physical activity score is zero.

    -   At the lowest level of physical activity, obese individuals have a QoL score 16.36 points lower than non-obese individuals (95% CI: −19.71, −13.01).

    -   Moreover, because the interaction term is negative, this disparity increases as physical activity levels rise, meaning that higher physical activity widens the QoL gap between obese and non-obese individuals rather than narrowing it.

**3. Practical Implications**

-   From a public health perspective, these findings underscore the central role of physical activity in improving quality of life, while also highlighting obesity as a major determinant and modifier of this relationship.

-   Interventions promoting physical activity may yield substantial QoL gains, particularly among non-obese populations; however, the reduced benefit observed among obese individuals suggests that physical activity alone may be insufficient for this group.

-   Integrated strategies combining weight management, occupational health interventions, and tailored physical activity programs are likely needed to achieve meaningful QoL improvements, especially for long-serving workers and obese populations.

-   This supports a targeted, equity-focused approach to health promotion and chronic disease prevention.

## Interaction plot

```{r}
#| fig-cap: "**Figure 16: Interaction Plot Between Physical Activity and Obesity Status on qol**"

# Create interaction plot using interact_plot
interact_plot(
  m3,
  pred = phys_activity,
  modx = obesity,
  colors = c("steelblue", "red"),
  x.label = "Physical Activity Score",
  y.label = "Predicted Quality of Life Score",
  legend.main = "Obesity Status",
  modx.labels = c("Not Obese", "Obese")
) 
```

**Interpretation**: This interaction plot visually reinforces the regression findings. Among non-obese individuals, predicted QoL increases steadily and strongly with higher physical activity scores, showing a clear positive gradient. In contrast, among obese individuals, QoL remains consistently low and nearly flat across the entire range of physical activity, indicating minimal improvement even at higher activity levels. The widening gap between the two lines as physical activity increases illustrates the negative interaction effect, where obesity substantially attenuates the beneficial impact of physical activity on QoL. In practical terms, this suggests that while physical activity is highly effective in improving QoL for non-obese individuals, obese individuals may require additional or combined interventions (e.g., weight reduction, metabolic control, or occupational health support) for meaningful QoL gains.

# **Prediction**

## Create new data for prediction

```{r}
new_data <- expand.grid(
  years_working = seq(0, 40, by = 10),
  phys_activity = seq(0, 10, by = 2),
  obesity = c("not obese", "obese")
)

new_data |> datatable()
```

## Generate predictions with confidence intervals using final model

```{r}
predicted <- augment(m3, newdata = new_data, interval = "confidence", level = 0.95)
predicted |> datatable()
```

## Prediction visualization

```{r}
#| fig-cap: "**Figure 17: Predicted QoL Score by Physical Activity, Obesity, and Years Working**"

ggplot(predicted, aes(x = phys_activity, y = .fitted, color = obesity, fill = obesity)) +
  geom_ribbon(aes(ymin = .lower, ymax = .upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  facet_grid(~ years_working, labeller = label_both) + 
  scale_color_manual(values = c("obese" = "red", "not obese" = "steelblue")) +
  scale_fill_manual(values = c("obese" = "red", "not obese" = "steelblue")) +
  theme_minimal(base_size = 10) +
  labs(
    subtitle = "Stratified by Years of Working (Model Predictions with 95% CIs)",
    y = "Predicted QoL Score (0-100)",
    x = "Physical Activity Score (0-10)",
    color = "Group",
    fill = "Group"
  ) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )


```

**Interpretation**: The Prediction Plot visualizes the interaction between physical activity, obesity, and years working on the predicted QoL score. For individuals who are not obese, there is a strong, positive relationship where increasing physical activity significantly boosts qol across all levels of work experience. Conversely, for those categorized as obese, physical activity has a negligible or slightly negative impact on QoL, and their overall predicted scores are consistently lower than those of the non-obese group. Additionally, the stratification by years working shows a general downward shift in baseline QoL as work experience increases, though the distinct patterns between the obesity groups remain stable.

# **Conclusion**

The final model demonstrates that quality of life (QoL) is significantly influenced by years working, physical activity, obesity status, and their interaction. Longer working years are associated with a gradual decline in QoL, while higher physical activity strongly improves QoL among non-obese individuals. However, obesity markedly reduces QoL and attenuates the benefits of physical activity, highlighting a significant negative interaction. These findings emphasize the need for integrated interventions targeting both physical activity and weight management, particularly for obese and long-serving workers, to achieve meaningful improvements in QoL.

# **References**

1.  Dohme H, Malcherczyk D, Leckey K, Müller C. K-depth tests for testing simultaneously independence and other model assumptions in time series. Commun Stat Simul Comput. 2024 Oct \[cited 2025 Dec 28\]. doi: 10.1080/03610918.2024.2413905.

2.  Musa, K. I., Arifin, W. N., and Hanis, T. M. (2024). Data Analysis in Medicine and Health using R. Boca Raton: CRC Press. 

3.  Nau RF. Testing the assumptions of linear regression \[Internet\]. Durham (NC): Duke University; c2004 \[cited 2025 Dec 28\]. Available from: https://people.duke.edu/\~rnau/testing.htm
